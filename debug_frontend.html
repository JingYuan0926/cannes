<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug AI Data Analysis Pipeline</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin-bottom: 30px;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .step.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .step.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .step.loading {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .file-upload {
            margin-bottom: 20px;
        }
        .file-upload input[type="file"] {
            margin-bottom: 10px;
        }
        .logs {
            height: 300px;
            overflow-y: auto;
            background-color: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç AI Data Analysis Pipeline Debugger</h1>
        <p>Use this tool to test and debug your AI data analysis pipeline step by step.</p>
        
        <div class="file-upload">
            <h3>Upload Test Data</h3>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.json">
            <button onclick="createTestData()">Create Test CSV</button>
            <button onclick="testFullPipeline()">Test Full Pipeline</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div class="logs" id="logs"></div>
        
        <div id="step1" class="step">
            <h3>Step 1: ETL Service</h3>
            <p>Tests file upload and data extraction</p>
            <button onclick="testETL()">Test ETL</button>
            <div id="etlResult" class="result" style="display: none;"></div>
        </div>
        
        <div id="step2" class="step">
            <h3>Step 2: Preprocessing Service</h3>
            <p>Tests data preprocessing and standardization</p>
            <button onclick="testPreprocessing()" disabled>Test Preprocessing</button>
            <div id="preprocessResult" class="result" style="display: none;"></div>
        </div>
        
        <div id="step3" class="step">
            <h3>Step 3: EDA Service</h3>
            <p>Tests exploratory data analysis and visualization</p>
            <button onclick="testEDA()" disabled>Test EDA</button>
            <div id="edaResult" class="result" style="display: none;"></div>
        </div>
        
        <div id="step4" class="step">
            <h3>Step 4: Analysis Service</h3>
            <p>Tests machine learning analysis</p>
            <button onclick="testAnalysis()" disabled>Test Analysis</button>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let pipelineData = {};
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            logs.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function setStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }
        
        function createTestData() {
            const testData = `name,age,city,salary
John,30,NYC,50000
Jane,25,LA,45000
Bob,35,Chicago,55000
Alice,28,Houston,48000`;
            
            const blob = new Blob([testData], { type: 'text/csv' });
            const file = new File([blob], 'test_data.csv', { type: 'text/csv' });
            
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            
            log('Created test CSV file', 'success');
        }
        
        async function testETL() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                log('Please select a file first', 'error');
                return;
            }
            
            setStepStatus('step1', 'loading');
            log('Testing ETL service...');
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('goal', 'test analysis');
                
                const response = await fetch('http://localhost:3030/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ETL failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                pipelineData.etl = data;
                
                setStepStatus('step1', 'success');
                log(`ETL success: ${data.processed_data.length} rows processed`, 'success');
                
                document.getElementById('etlResult').style.display = 'block';
                document.getElementById('etlResult').textContent = JSON.stringify(data, null, 2);
                
                // Enable next step
                document.querySelector('#step2 button').disabled = false;
                
            } catch (error) {
                setStepStatus('step1', 'error');
                log(`ETL error: ${error.message}`, 'error');
                
                document.getElementById('etlResult').style.display = 'block';
                document.getElementById('etlResult').textContent = error.message;
            }
        }
        
        async function testPreprocessing() {
            if (!pipelineData.etl) {
                log('Run ETL first', 'error');
                return;
            }
            
            setStepStatus('step2', 'loading');
            log('Testing preprocessing service...');
            
            try {
                const response = await fetch('http://localhost:3031/preprocess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: pipelineData.etl.processed_data,
                        goal: 'machine learning preparation'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Preprocessing failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                pipelineData.preprocessing = data;
                
                setStepStatus('step2', 'success');
                log(`Preprocessing success: ${data.processed_shape} shape`, 'success');
                
                document.getElementById('preprocessResult').style.display = 'block';
                document.getElementById('preprocessResult').textContent = JSON.stringify(data, null, 2);
                
                // Enable next step
                document.querySelector('#step3 button').disabled = false;
                
            } catch (error) {
                setStepStatus('step2', 'error');
                log(`Preprocessing error: ${error.message}`, 'error');
                
                document.getElementById('preprocessResult').style.display = 'block';
                document.getElementById('preprocessResult').textContent = error.message;
            }
        }
        
        async function testEDA() {
            if (!pipelineData.preprocessing) {
                log('Run preprocessing first', 'error');
                return;
            }
            
            setStepStatus('step3', 'loading');
            log('Testing EDA service...');
            
            try {
                const response = await fetch('http://localhost:3035/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: pipelineData.preprocessing.processed_data,
                        prompt: 'Comprehensive data analysis'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`EDA failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                pipelineData.eda = data;
                
                setStepStatus('step3', 'success');
                log(`EDA success: ${data.visualizations?.length || 0} visualizations`, 'success');
                
                document.getElementById('edaResult').style.display = 'block';
                document.getElementById('edaResult').textContent = JSON.stringify(data, null, 2);
                
                // Enable next step
                document.querySelector('#step4 button').disabled = false;
                
            } catch (error) {
                setStepStatus('step3', 'error');
                log(`EDA error: ${error.message}`, 'error');
                
                document.getElementById('edaResult').style.display = 'block';
                document.getElementById('edaResult').textContent = error.message;
            }
        }
        
        async function testAnalysis() {
            if (!pipelineData.preprocessing) {
                log('Run preprocessing first', 'error');
                return;
            }
            
            setStepStatus('step4', 'loading');
            log('Testing analysis service...');
            
            try {
                const response = await fetch('http://localhost:3040/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: pipelineData.preprocessing.processed_data,
                        goal: 'comprehensive analysis'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                pipelineData.analysis = data;
                
                setStepStatus('step4', 'success');
                log(`Analysis success: ${data.insights?.length || 0} insights`, 'success');
                
                document.getElementById('analysisResult').style.display = 'block';
                document.getElementById('analysisResult').textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                setStepStatus('step4', 'error');
                log(`Analysis error: ${error.message}`, 'error');
                
                document.getElementById('analysisResult').style.display = 'block';
                document.getElementById('analysisResult').textContent = error.message;
            }
        }
        
        async function testFullPipeline() {
            log('Starting full pipeline test...', 'info');
            clearLogs();
            
            // Reset all steps
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                setStepStatus(id, '');
                document.getElementById(id.replace('step', id.charAt(4) === '1' ? 'etl' : 
                    id.charAt(4) === '2' ? 'preprocess' : 
                    id.charAt(4) === '3' ? 'eda' : 'analysis') + 'Result').style.display = 'none';
            });
            
            // Disable all buttons except ETL
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes('Test') && !btn.textContent.includes('ETL')) {
                    btn.disabled = true;
                }
            });
            
            // Create test data if no file selected
            if (!document.getElementById('fileInput').files.length) {
                createTestData();
            }
            
            // Run pipeline step by step
            await testETL();
            if (pipelineData.etl) {
                await testPreprocessing();
                if (pipelineData.preprocessing) {
                    await testEDA();
                    if (pipelineData.eda) {
                        await testAnalysis();
                    }
                }
            }
            
            log('Pipeline test completed', 'info');
        }
        
        // Initialize
        log('Debug tool loaded. Ready to test pipeline.', 'success');
    </script>
</body>
</html> 